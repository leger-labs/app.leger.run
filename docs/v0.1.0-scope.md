# Leger v0.1.0: Backend Implementation Specification

**Document Version:** 2.0  
**Date:** October 2025  
**Purpose:** Complete technical specification for Leger v0.1.0 backend infrastructure, establishing production-ready foundation for secret management and release storage.

**Scope:** Minimum Viable Product enabling CLI-driven secret management and establishing R2 storage infrastructure for future quadlet serving (v0.2.0+).

---

## Table of Contents

1. [Product Scope & Objectives](#product-scope--objectives)
2. [Architecture Overview](#architecture-overview)
3. [Authentication System](#authentication-system)
4. [Data Models & Storage](#data-models--storage)
5. [API Endpoints](#api-endpoints)
6. [Frontend Application](#frontend-application)
7. [Infrastructure Setup](#infrastructure-setup)
8. [Security Implementation](#security-implementation)
9. [Deployment](#deployment)
10. [Success Criteria](#success-criteria)

---

## Product Scope & Objectives

### v0.1.0 Deliverables

**Core Infrastructure:**
1. Tailscale-based authentication (CLI + web)
2. Encrypted secret storage (API keys, tokens)
3. R2 bundle storage infrastructure
4. User account management (D1 foundation)
5. Web UI for secret management
6. Release list/detail views (read-only metadata)

**What Users Can Do:**
- Authenticate via Tailscale from CLI and browser
- Create/read/update/delete API secrets via web UI
- CLI can fetch secrets for deployment
- Upload release bundles for storage (manual testing)
- View stored releases in web UI

**Foundation for v0.2.0+:**
- D1 database with full schema (tables created but unused)
- R2 bucket structure established
- Versioning pattern implemented
- Component library deployed

**Explicitly Deferred to v0.2.0+:**
- Web UI template application (29 decision variables)
- Server-side template rendering
- Serving rendered quadlets as static site
- Marketplace/integrations
- Advanced release configuration
- CLI pulling rendered quadlets from Leger backend

**v0.1.0 Clarification:**
- CLI pulls quadlet templates from **GitHub repos** (static git pull)
- Leger backend stores **release bundles** in R2 for future serving
- v0.2.0 will serve rendered quadlets as static HTTPS site
- v0.1.0 focuses on secrets + infrastructure setup

---

## Architecture Overview

### Technology Stack

**Backend:**
- Cloudflare Workers (serverless edge compute)
- Cloudflare KV (secret storage, user cache)
- Cloudflare R2 (release bundle storage)
- Cloudflare D1 (user database, release metadata)
- Tailscale API (authentication only)

**Frontend:**
- React 18.2 + TypeScript
- Vite build system + Wrangler deployment
- Tailwind CSS + shadcn/ui components
- Standard browser fetch for API calls

**Deployment:**
- GitHub Actions → Cloudflare Workers
- No staging environment (production only)
- Minimal testing (deploy to production directly)

### System Architecture

```
┌─────────────────────────────────────────────────────┐
│                   User Layer                        │
│  ┌──────────────┐           ┌──────────────┐      │
│  │ Web Browser  │           │  Leger CLI   │      │
│  │ (React SPA)  │           │   (Go)       │      │
│  └──────┬───────┘           └──────┬───────┘      │
│         │                           │              │
│         └──────────┬────────────────┘              │
│                    │                               │
└────────────────────┼───────────────────────────────┘
                     │ HTTPS + JWT
┌────────────────────▼───────────────────────────────┐
│         Cloudflare Workers (Global Edge)           │
│  ┌─────────────────────────────────────────────┐  │
│  │            api/index.ts                     │  │
│  │  • /health       → Health check             │  │
│  │  • /api/auth/*   → Authentication           │  │
│  │  • /api/secrets/*→ Secret CRUD              │  │
│  │  • /api/releases/*→ Release metadata        │  │
│  │  • /*            → SPA fallback             │  │
│  └─────────────────────────────────────────────┘  │
│         │             │              │             │
│         ▼             ▼              ▼             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │    KV    │  │    R2    │  │    D1    │        │
│  │ Secrets  │  │ Bundles  │  │  Users   │        │
│  │  Users   │  │ (tar.gz) │  │ Releases │        │
│  └──────────┘  └──────────┘  └──────────┘        │
└────────────────────────────────────────────────────┘
                     │
                     ▼
          ┌────────────────────┐
          │  Tailscale API     │
          │ (Identity Verify)  │
          └────────────────────┘
```

### Responsibilities

**Worker:**
- Route HTTP requests
- Verify Tailscale identity → issue JWT
- Encrypt/decrypt secrets
- Store/retrieve release bundles
- Serve React SPA

**KV:**
- User metadata (fast edge cache)
- Encrypted secrets
- Release manifest pointers

**R2:**
- Release bundles (`.tar.gz` files)
- One bundle = one complete release
- Private bucket (no public access)

**D1:**
- User accounts (normalized)
- Release metadata (versioning)
- Foundation tables for v0.2.0+

---

## Authentication System

### Tailscale Authentication Flow

**Complete Sequence:**

1. **User Prerequisites:**
   - Tailscale installed and running
   - HTTPS + MagicDNS enabled on Tailscale account
   - Leger CLI installed

2. **CLI Initiates Login:**
   ```bash
   $ leger login
   ```
   - CLI runs: `tailscale status --json`
   - Extracts: `user_id`, `email`, `tailnet`, `device_id`, `hostname`
   - Opens browser: `https://app.leger.run/auth/callback?device_id={id}`

3. **Browser Authentication:**
   - Browser makes request to Worker
   - Worker receives Tailscale identity from request context
   - Worker calls Tailscale API: `GET /api/v2/tailnet/{tailnet}/devices`
   - Worker verifies device_id + user_id match in response
   - If verified → Generate JWT

4. **JWT Issuance:**
   ```typescript
   interface JWTPayload {
     sub: string;              // user_uuid (UUID v5 from tailscale_user_id)
     tailscale_user_id: string;
     email: string;
     tailnet: string;
     iat: number;              // Issued at
     exp: number;              // Expires (30 days)
   }
   ```
   - Algorithm: HS256
   - Secret: `JWT_SECRET` (Wrangler secret)
   - Expiry: 30 days

5. **Token Distribution:**
   - Browser stores JWT in `localStorage`
   - Browser displays: "Login successful! Return to CLI"
   - CLI receives token via callback mechanism
   - CLI stores in `~/.leger/config`

6. **User Account Creation (First Time):**
   - Worker checks D1: `SELECT * FROM users WHERE tailscale_user_id = ?`
   - If not exists:
     - Generate `user_uuid` = UUID v5 from `tailscale_user_id`
     - Insert into D1 `users` table
     - Insert into KV `user:{user_uuid}` for fast access
   - If exists:
     - Update `last_seen` timestamp
     - Update `last_device_id`

### Authentication on Protected Routes

**Every API request:**
```
1. Extract: Authorization: Bearer {jwt}
2. Verify JWT signature (JWT_SECRET)
3. Check expiration (exp claim)
4. Extract user_uuid from sub claim
5. Proceed with request
```

**No additional verification needed** - JWT proves Tailscale authentication already completed.

---

## Data Models & Storage

### Cloudflare KV Namespaces

#### Namespace: `LEGER_USERS`

**Key:** `user:{user_uuid}`

**Value:**
```typescript
interface UserRecord {
  user_uuid: string;              // UUID v5 from tailscale_user_id
  tailscale_user_id: string;      // "u123456789"
  tailscale_email: string;        // "alice@github"
  tailnet: string;                // "example.ts.net"
  display_name: string | null;
  created_at: string;             // ISO 8601
  last_seen: string;
  last_device_id: string;
  last_device_hostname: string;
  cli_version: string;
  total_authentications: number;
}
```

**Access Pattern:**
- Read: Every authenticated request (cache)
- Write: On authentication
- TTL: None

---

#### Namespace: `LEGER_SECRETS`

**Key:** `secrets:{user_uuid}:{secret_name}`

**Value:**
```typescript
interface SecretRecord {
  secret_id: string;            // UUID v4
  user_uuid: string;
  name: string;                 // "openai_api_key"
  encrypted_value: string;      // Base64 AES-256-GCM ciphertext
  nonce: string;                // Base64 96-bit nonce
  auth_tag: string;             // Base64 128-bit auth tag
  encryption_version: number;   // Always 1 for v0.1.0
  version: number;              // Increments on update
  created_at: string;
  updated_at: string;
  last_accessed: string | null;
}
```

**Encryption (Server-Side):**
```
Plaintext → AES-256-GCM (Web Crypto API)
         → { ciphertext, nonce, auth_tag }
         → Store in KV
         → Never log plaintext
```

**Decryption (Server-Side):**
```
Retrieve from KV → AES-256-GCM decrypt
                → Return plaintext to authorized user
```

**Master Key:** `ENCRYPTION_KEY` (Wrangler secret, 256-bit)

---

#### Namespace: `LEGER_MANIFESTS`

**Key:** `manifest:{user_uuid}:v{version}`

**Value:**
```typescript
interface ManifestRecord {
  manifest_id: string;          // UUID v4
  user_uuid: string;
  version: number;              // 1, 2, 3...
  deployment_name: string;
  r2_path: string;              // "{user_uuid}/v{N}.tar.gz"
  bundle_size_bytes: number;
  created_at: string;
  
  // Extracted from bundle's manifest.json
  files: string[];              // ["openwebui.container", ...]
  services: string[];           // ["openwebui", "litellm"]
  secrets_required: string[];   // ["openai_api_key"]
}
```

**Latest Pointer:**

**Key:** `manifest:{user_uuid}:latest`

**Value:**
```json
{
  "version": 3,
  "manifest_id": "...",
  "updated_at": "2025-10-16T14:00:00Z"
}
```

---

### Cloudflare R2 Storage

**Bucket:** `leger-quadlets-prod`

**Structure:**
```
leger-quadlets-prod/
├── {user_uuid}/
│   ├── v1.tar.gz          # Complete release bundle
│   ├── v2.tar.gz
│   ├── v3.tar.gz
│   └── latest.tar.gz      # Copy of latest version
```

**Bundle Contents (tar.gz):**
```
v3.tar.gz:
├── manifest.json          # Metadata: services, secrets, etc.
├── openwebui.container
├── openwebui.volume
├── litellm.container
└── (all .container, .volume, .network files)
```

**manifest.json Structure:**
```json
{
  "version": 3,
  "deployment_name": "openwebui",
  "created_at": "2025-10-16T14:00:00Z",
  "files": [
    "openwebui.container",
    "openwebui.volume",
    "litellm.container"
  ],
  "services": [
    {
      "name": "openwebui",
      "type": "container",
      "image": "ghcr.io/open-webui/open-webui:main"
    }
  ],
  "secrets_required": ["openai_api_key", "anthropic_api_key"]
}
```

**Upload Flow:**
1. Client: `POST /api/releases` with tarball body
2. Worker receives stream
3. Worker stores: `{user_uuid}/v{N}.tar.gz` in R2
4. Worker extracts manifest.json (peek into tar)
5. Worker stores manifest metadata in KV
6. Worker inserts record in D1 `releases` table
7. Worker returns: `{ version: N, size: X }`

**Download Flow (v0.1.0 - Manual Testing Only):**
1. Client: `GET /api/releases/:version`
2. Worker retrieves from R2
3. Worker streams tarball to client
4. No checksums in v0.1.0 (add in v0.2.0 if needed)

---

### Cloudflare D1 Database

**Users Table:**
```sql
CREATE TABLE users (
    user_uuid TEXT PRIMARY KEY,
    tailscale_user_id TEXT NOT NULL UNIQUE,
    tailscale_email TEXT NOT NULL,
    tailnet TEXT NOT NULL,
    display_name TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_device_id TEXT,
    last_device_hostname TEXT,
    cli_version TEXT,
    total_authentications INTEGER DEFAULT 0
);

CREATE INDEX idx_users_tailscale_id ON users(tailscale_user_id);
CREATE INDEX idx_users_tailnet ON users(tailnet);
```

**Releases Table:**
```sql
CREATE TABLE releases (
    id TEXT PRIMARY KEY,
    user_uuid TEXT NOT NULL,
    version INTEGER NOT NULL,
    deployment_name TEXT NOT NULL,
    r2_path TEXT NOT NULL,
    bundle_size_bytes INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_uuid) REFERENCES users(user_uuid) ON DELETE CASCADE
);

CREATE UNIQUE INDEX idx_release_user_version ON releases(user_uuid, version);
CREATE INDEX idx_release_user ON releases(user_uuid);
```

**Future Tables (Created but Unused in v0.1.0):**
- `configurations` - For v0.2.0 template application
- `configuration_versions` - For v0.2.0 versioning
- `schemas` - For v0.2.0 template registry
- `rendered_quadlets` - For v0.2.0 rendering tracking
- `deployments` - For v0.2.0 device tracking

**Migration File:** `db/migrations/0001_initial_schema.sql`

---

## API Endpoints

### Authentication

**POST /api/auth/cli**

**Purpose:** Verify Tailscale identity, issue JWT

**Request:**
```json
{
  "device_id": "d987654321",
  "user_id": "u123456789",
  "email": "alice@github",
  "tailnet": "example.ts.net",
  "hostname": "alice-laptop"
}
```

**Response (Success):**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "user_uuid": "550e8400-e29b-41d4-a716-446655440000",
      "email": "alice@github",
      "display_name": "Alice Smith"
    }
  }
}
```

**Response (Failure):**
```json
{
  "success": false,
  "error": {
    "code": "tailscale_verification_failed",
    "message": "Device not found in tailnet",
    "action": "Check Tailscale status: tailscale status"
  }
}
```

---

### Secrets Management

**All require:** `Authorization: Bearer {jwt}`

**GET /api/secrets**

**Response:**
```json
{
  "success": true,
  "data": {
    "secrets": [
      {
        "name": "openai_api_key",
        "created_at": "2025-10-15T10:00:00Z",
        "updated_at": "2025-10-16T12:00:00Z",
        "version": 2
      }
    ]
  }
}
```

---

**GET /api/secrets/:name**

**Response:**
```json
{
  "success": true,
  "data": {
    "name": "openai_api_key",
    "value": "sk-proj-abc123...",
    "version": 2,
    "created_at": "2025-10-15T10:00:00Z"
  }
}
```

---

**POST /api/secrets/:name**

**Request:**
```json
{
  "value": "sk-proj-abc123..."
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "name": "openai_api_key",
    "version": 1,
    "created_at": "2025-10-16T14:00:00Z"
  }
}
```

---

**DELETE /api/secrets/:name**

**Response:**
```json
{
  "success": true,
  "data": {
    "deleted": true
  }
}
```

---

### Release Management

**All require:** `Authorization: Bearer {jwt}`

**GET /api/releases**

**Response:**
```json
{
  "success": true,
  "data": {
    "releases": [
      {
        "version": 3,
        "deployment_name": "openwebui",
        "bundle_size_bytes": 15360,
        "created_at": "2025-10-16T14:00:00Z"
      }
    ]
  }
}
```

---

**GET /api/releases/latest**

**Response:**
```json
{
  "success": true,
  "data": {
    "version": 3,
    "deployment_name": "openwebui",
    "r2_path": "{user_uuid}/v3.tar.gz",
    "bundle_size_bytes": 15360,
    "files": ["openwebui.container", "litellm.container"],
    "services": ["openwebui", "litellm"],
    "secrets_required": ["openai_api_key"]
  }
}
```

---

**GET /api/releases/:version**

**Same as latest, but specific version**

---

**POST /api/releases**

**Purpose:** Upload new release bundle

**Request:** Raw tarball in body (`Content-Type: application/gzip`)

**Response:**
```json
{
  "success": true,
  "data": {
    "version": 4,
    "bundle_size_bytes": 20480,
    "r2_path": "{user_uuid}/v4.tar.gz",
    "created_at": "2025-10-17T10:00:00Z"
  }
}
```

---

**GET /api/releases/:version/download**

**Purpose:** Download bundle (v0.1.0 testing only)

**Response:** Tarball stream (`Content-Type: application/gzip`)

---

### Health Check

**GET /health** (Public, no auth)

**Response:**
```json
{
  "status": "healthy",
  "service": "leger-app",
  "timestamp": "2025-10-17T12:34:56Z",
  "version": "0.1.0",
  "environment": "production"
}
```

---

## Frontend Application

### Page Structure

**Routes:**
- `/` → Redirect to `/api-keys`
- `/api-keys` → Secret management page (DEFAULT)
- `/releases` → Release list page
- `/releases/:version` → Release detail page
- `/settings` → Account settings page
- `/login` → Authentication landing

**All routes except `/login` require authentication (JWT in localStorage)**

### Key Pages

**1. API Keys Page (`/api-keys`)**

**Purpose:** Manage API secrets

**Layout:**
```
PageLayout
├─ PageHeader (title: "API Keys & Integrations")
├─ CategorySection (OpenAI)
│  ├─ SecretField (API Key)
│  ├─ TextField (Organization ID, optional)
│  └─ SaveButton
├─ CategorySection (Anthropic)
│  ├─ SecretField (API Key)
│  └─ SaveButton
└─ CategorySection (Google AI)
   └─ (similar)
```

**Features:**
- Each provider section has independent save
- Secrets masked by default (show/hide toggle)
- Dirty state tracking per section

---

**2. Releases Page (`/releases`)**

**Purpose:** List all stored releases

**Layout:**
```
PageLayout
├─ PageHeader (title: "Releases")
├─ Grid of release cards
│  └─ Each card shows:
│     • Version number
│     • Deployment name
│     • File count
│     • Created date
│     • View button → /releases/:version
└─ Empty state (if no releases)
```

---

**3. Release Detail Page (`/releases/:version`)**

**Purpose:** View single release metadata

**Layout:**
```
PageLayout
├─ Breadcrumb: Releases / v3
├─ PageHeader
│  ├─ Title: "Release v3"
│  └─ Download button
├─ CategorySection: Metadata
│  ├─ Deployment name
│  ├─ Bundle size
│  ├─ Created date
│  └─ R2 path
├─ CategorySection: Files
│  └─ List of .container files
└─ CategorySection: Secrets Required
   └─ List of secret names
```

---

**4. Settings Page (`/settings`)**

**Purpose:** Account information

**Layout:**
```
PageLayout
├─ CategorySection: Profile
│  ├─ Display name (read-only for now)
│  ├─ Email (read-only)
│  └─ Tailnet (read-only)
└─ CategorySection: Leger ID
   └─ user_uuid (read-only, copyable)
```

---

### Component Usage

**From Component Catalogue:**
- `CategorySection` - Independent save sections
- `SecretField` - Masked input with show/hide
- `TextField` - Standard text input
- `SaveButton` - Dirty state aware
- `Card` - Release list items
- `Badge` - Status indicators

**State Management:**
- React Context for auth state
- Component-local state for forms
- localStorage for JWT persistence

**API Communication:**
- Standard `fetch()` calls
- Bearer token in Authorization header
- JSON request/response bodies

---

## Infrastructure Setup

### Cloudflare Resources

**Create KV Namespaces:**
```bash
wrangler kv:namespace create "LEGER_USERS"
wrangler kv:namespace create "LEGER_USERS" --preview

wrangler kv:namespace create "LEGER_SECRETS"
wrangler kv:namespace create "LEGER_SECRETS" --preview

wrangler kv:namespace create "LEGER_MANIFESTS"
wrangler kv:namespace create "LEGER_MANIFESTS" --preview
```

**Create R2 Bucket:**
```bash
wrangler r2 bucket create leger-quadlets-prod
wrangler r2 bucket create leger-quadlets-preview
```

**Create D1 Database:**
```bash
wrangler d1 create leger-db-prod
wrangler d1 create leger-db-preview
```

**Apply D1 Migration:**
```bash
wrangler d1 execute leger-db-prod --file=./db/migrations/0001_initial_schema.sql
```

**Set Secrets:**
```bash
wrangler secret put ENCRYPTION_KEY
wrangler secret put TAILSCALE_API_KEY
wrangler secret put JWT_SECRET
```

---

### Wrangler Configuration

**File:** `wrangler.toml`

```toml
name = "leger-app"
compatibility_date = "2025-04-01"
main = "api/index.ts"

[assets]
directory = "./dist"
binding = "ASSETS"
not_found_handling = "single-page-application"

[[kv_namespaces]]
binding = "LEGER_USERS"
id = "your-users-kv-id-here"
preview_id = "your-users-preview-kv-id"

[[kv_namespaces]]
binding = "LEGER_SECRETS"
id = "your-secrets-kv-id-here"
preview_id = "your-secrets-preview-kv-id"

[[kv_namespaces]]
binding = "LEGER_MANIFESTS"
id = "your-manifests-kv-id-here"
preview_id = "your-manifests-preview-kv-id"

[[r2_buckets]]
binding = "LEGER_QUADLETS"
bucket_name = "leger-quadlets-prod"
preview_bucket_name = "leger-quadlets-preview"

[[d1_databases]]
binding = "LEGER_DB"
database_name = "leger-db-prod"
database_id = "your-d1-database-id-here"
preview_database_id = "your-d1-preview-database-id"

[vars]
ENVIRONMENT = "production"
APP_VERSION = "0.1.0"

[placement]
mode = "smart"
```

**Environment Interface:**
```typescript
export interface Env {
  ASSETS: Fetcher;
  LEGER_USERS: KVNamespace;
  LEGER_SECRETS: KVNamespace;
  LEGER_MANIFESTS: KVNamespace;
  LEGER_QUADLETS: R2Bucket;
  LEGER_DB: D1Database;
  ENVIRONMENT: string;
  APP_VERSION: string;
  ENCRYPTION_KEY: string;
  TAILSCALE_API_KEY: string;
  JWT_SECRET: string;
}
```

---

### Build Scripts

**package.json:**
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build && npm run build:worker",
    "build:worker": "node scripts/build-worker.js",
    "deploy": "npm run build && wrangler deploy",
    "typecheck": "tsc --noEmit",
    "lint": "eslint . --ext ts,tsx",
    "db:migrate": "wrangler d1 execute leger-db-prod --file=./db/migrations/0001_initial_schema.sql"
  }
}
```

---

## Security Implementation

### Secret Encryption

**Standard Cloudflare KV Secret Storage Pattern:**

**Encryption (Web Crypto API):**
```typescript
async function encryptSecret(plaintext: string, masterKey: string): Promise<{
  encrypted_value: string;
  nonce: string;
  auth_tag: string;
}> {
  // Import master key
  const key = await crypto.subtle.importKey(
    'raw',
    new TextEncoder().encode(masterKey),
    'AES-GCM',
    false,
    ['encrypt']
  );
  
  // Generate random nonce
  const nonce = crypto.getRandomValues(new Uint8Array(12));
  
  // Encrypt
  const encrypted = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv: nonce },
    key,
    new TextEncoder().encode(plaintext)
  );
  
  return {
    encrypted_value: base64Encode(encrypted),
    nonce: base64Encode(nonce),
    auth_tag: base64Encode(encrypted.slice(-16)) // Last 16 bytes
  };
}
```

**Decryption:**
```typescript
async function decryptSecret(
  encrypted_value: string,
  nonce: string,
  masterKey: string
): Promise<string> {
  const key = await crypto.subtle.importKey(
    'raw',
    new TextEncoder().encode(masterKey),
    'AES-GCM',
    false,
    ['decrypt']
  );
  
  const decrypted = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv: base64Decode(nonce) },
    key,
    base64Decode(encrypted_value)
  );
  
  return new TextDecoder().decode(decrypted);
}
```

**Security Rules:**
- Master key never logged
- Plaintext never logged
- Encryption server-side only
- Nonce unique per secret
- Auth tag prevents tampering

---

### JWT Security

**Generation:**
```typescript
import { SignJWT } from 'jose';

async function generateJWT(user: UserRecord, secret: string): Promise<string> {
  return await new SignJWT({
    sub: user.user_uuid,
    tailscale_user_id: user.tailscale_user_id,
    email: user.tailscale_email,
    tailnet: user.tailnet,
  })
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('30d')
    .sign(new TextEncoder().encode(secret));
}
```

**Verification:**
```typescript
import { jwtVerify } from 'jose';

async function verifyJWT(token: string, secret: string): Promise<JWTPayload> {
  const { payload } = await jwtVerify(
    token,
    new TextEncoder().encode(secret)
  );
  return payload as JWTPayload;
}
```

---

## Deployment

### GitHub Actions Workflow

**File:** `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run typecheck
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build
      
      - name: Apply D1 migrations
        run: wrangler d1 migrations apply leger-db-prod --remote
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      
      - name: Deploy to Cloudflare
        run: wrangler deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      
      - name: Health check
        run: |
          sleep 10
          curl -f https://leger.run/health || exit 1
```

**GitHub Secrets Required:**
- `CLOUDFLARE_ACCOUNT_ID`
- `CLOUDFLARE_API_TOKEN`

---

## Success Criteria

### Functional Requirements

- [ ] User runs `leger login` → Browser opens → JWT returned to CLI
- [ ] User creates secret "openai_api_key" via web UI → Encrypted in KV
- [ ] User retrieves secret via web UI → Decrypted correctly
- [ ] CLI retrieves secret using JWT → Returns plaintext value
- [ ] User uploads release bundle → Stored in R2 with version
- [ ] User views releases in web UI → List shows all versions
- [ ] User views release detail → Shows metadata from manifest.json
- [ ] D1 database created with all tables (including unused v0.2.0 tables)

### Infrastructure Validation

- [ ] KV namespaces created and bound
- [ ] R2 bucket created and bound
- [ ] D1 database created with migrations applied
- [ ] Wrangler secrets configured (ENCRYPTION_KEY, TAILSCALE_API_KEY, JWT_SECRET)
- [ ] GitHub Actions deploys successfully
- [ ] Health check returns 200

### Security Validation

- [ ] Secrets encrypted at rest in KV
- [ ] No plaintext in logs
- [ ] JWT signature verified on protected routes
- [ ] Tailscale identity verified against API
- [ ] R2 bucket not publicly accessible

### End-to-End Test

1. Fresh user with Tailscale installed
2. Run `leger login` → Authenticate successfully
3. Visit `app.leger.run` → See `/api-keys` page
4. Create secret "test_key" with value "test123"
5. CLI runs: `leger secrets get test_key` → Returns "test123"
6. Upload test bundle via CLI
7. View release in web UI
8. Download bundle via CLI
9. Verify bundle contents match upload

**If all steps pass → v0.1.0 complete**

---

## Document Metadata

**Version:** 2.0 (Simplified)  
**Status:** Authoritative specification for v0.1.0  
**Last Updated:** October 2025

**Key Simplifications from v1.0:**
- Removed React Router discussion (SPA routing already solved)
- Simplified R2 to atomic bundles (no pre-signed URLs)
- Removed bundle checksums (add in v0.2.0 if needed)
- Clarified v0.1.0 infrastructure setup vs. v0.2.0 feature completion
- Focused on essential: auth + secrets + storage foundation

---

**END OF SPECIFICATION**
