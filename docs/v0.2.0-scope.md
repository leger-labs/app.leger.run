V2 Release Save/Deploy Functionality - Investigation Report
Executive Summary
STATUS: v2 save/deploy functionality DOES NOT EXIST yet

The repository has v0.1.0 implemented and released (basic secret management + release metadata tracking). The infrastructure for v0.2.0 is prepared but empty:

✅ Database tables created (unused)
✅ R2 bucket configured (empty)
❌ NO template rendering
❌ NO deployment workflow
❌ NO CLI pull mechanism
Current Implementation Status
What EXISTS (v0.1.0)
1. Release Metadata CRUD
Files: api/routes/releases.ts, api/services/releases.ts, api/models/release.ts

The release model currently stores:

interface ReleaseRecord {
  id: string                 // UUID
  user_uuid: string          // Owner
  name: string               // "my-openwebui"
  git_url: string            // GitHub URL only
  git_branch: string         // "main"
  description: string | null
  version: number            // Auto-increment
  created_at: string
  updated_at: string
}
Current workflow: User creates release → Stores metadata in D1 → CLI fetches git_url → CLI clones directly from GitHub

No leger.run hosting involved

2. Database Schema (Prepared for v0.2.0)
File: db/migrations/0001_initial.sql

Unused tables exist:

-- Lines 42-52: configurations table
- Stores config_data as JSON
- Links to release_id
- Has schema_version tracking

-- Lines 59-71: deployments table  
- Tracks deployment status (rendering, uploading, ready, deployed, failed)
- Stores r2_path and manifest_url
- Has error_message field
- Timestamps for started_at, completed_at
These tables have ZERO rows - created for future use.

3. R2 Bucket Configuration
File: wrangler.toml:22-24

[[r2_buckets]]
binding = "LEGER_STATIC"
bucket_name = "leger-static-sites"
Bucket exists but:

No upload code
No download code
No file management
Completely empty
4. Frontend Placeholder
File: src/pages/ReleaseFormPage.tsx:110

<Button variant="outline" size="sm" className="flex-1" disabled>
  Deploy
</Button>
Deploy button exists but is explicitly disabled with no click handler.

What DOES NOT EXIST (v0.2.0)
Missing Component #1: Template Rendering Engine
Required functionality: Process Nunjucks templates with user configuration

Files needed:

api/services/template-renderer.ts
api/lib/nunjucks-engine.ts
api/templates/           (you mentioned these exist but I cannot find them)
What it should do:

Load .njk template files
Accept configuration JSON (29 decision variables)
Render quadlet files (.container, .network, .volume)
Validate output
Return rendered file set
Example flow:

// Input
const config = {
  enable_openwebui: true,
  openwebui_host_port: 8080,
  enable_gpu: false,
  // ... 26 more variables
}

// Process
const renderer = new TemplateRenderer()
const files = await renderer.render('openwebui', config)

// Output
files = {
  'openwebui.container': '...',
  'openwebui.network': '...',
  'volumes.network': '...',
  'manifest.json': '...'
}
Current status: DOES NOT EXIST

Missing Component #2: R2 Upload/Storage Service
Required functionality: Store rendered files in R2 with versioning

Files needed:

api/services/r2-storage.ts
api/lib/r2-client.ts
What it should do:

Accept rendered file set
Create version path: {user_uuid}/v{N}/
Upload all files to R2
Create latest symlink/metadata
Generate public manifest URL
Return storage metadata
Example flow:

const storage = new R2Storage(env.LEGER_STATIC)

// Upload
const result = await storage.uploadRelease({
  user_uuid: '550e8400-...',
  version: 3,
  files: {
    'openwebui.container': '...',
    'manifest.json': '...'
  }
})

// Result
result = {
  r2_path: '550e8400-.../v3/',
  manifest_url: 'https://static.leger.run/550e8400-.../v3/manifest.json',
  file_count: 4,
  total_bytes: 8192
}
R2 structure:

leger-static-sites/
├── 550e8400-e29b-41d4-a716-446655440000/
│   ├── v1/
│   │   ├── manifest.json
│   │   ├── openwebui.container
│   │   ├── openwebui.network
│   │   └── volumes.volume
│   ├── v2/
│   │   └── ...
│   ├── v3/
│   │   └── ...
│   └── latest.json  ← Points to v3
Current status: DOES NOT EXIST

Missing Component #3: Deployment Workflow Orchestrator
Required functionality: Coordinate rendering → uploading → tracking

Files needed:

api/services/deployment-orchestrator.ts
api/routes/deployments.ts
api/models/deployment.ts
What it should do:

Phase 1: Initiate Deployment

POST /api/releases/:id/deploy

1. Validate release exists
2. Fetch configuration from configurations table
3. Create deployment record with status='rendering'
4. Return deployment_id for tracking
Phase 2: Render Templates

// Background or sync processing
1. Update status='rendering'
2. Load templates
3. Render with config
4. Validate output
5. Update status='uploading' or 'failed'
Phase 3: Upload to R2

1. Update status='uploading'
2. Upload files to R2
3. Generate manifest
4. Update deployment record:
   - status='ready'
   - r2_path
   - manifest_url
   - completed_at
Phase 4: Track Progress

GET /api/releases/:id/deploy

Returns:
{
  deployment_id: '...',
  status: 'uploading',  // or 'rendering', 'ready', 'failed'
  progress: 75,
  current_step: 'Uploading files to R2',
  r2_path: null,        // populated when ready
  manifest_url: null,   // populated when ready
  error_message: null
}
Current status: DOES NOT EXIST

Missing Component #4: Configuration Management
Required functionality: Store and version user configuration

Files needed:

api/services/configurations.ts
api/routes/configurations.ts
api/models/configuration.ts
What it should do:

Save Configuration:

POST /api/releases/:id/configuration

Body:
{
  config_data: {
    enable_openwebui: true,
    openwebui_host_port: 8080,
    enable_gpu: false,
    // ... 26 more
  },
  schema_version: "1.0.0"
}

→ Insert into configurations table
→ Auto-increment version
→ Return configuration_id
Retrieve Configuration:

GET /api/releases/:id/configuration

Returns latest configuration for release
Used by deployment orchestrator
Current status: DOES NOT EXIST

Configuration table exists (db/migrations/0001_initial.sql:42-52) but has zero code using it.

Missing Component #5: CLI Pull Endpoints
Required functionality: CLI can fetch rendered files from R2

Files needed:

api/routes/cli.ts
api/services/manifest.ts
What it should do:

Fetch Latest Manifest:

GET /api/config/latest
  or
GET /api/users/me/releases/:name/latest

Returns:
{
  release_name: 'my-openwebui',
  version: 3,
  manifest_url: 'https://static.leger.run/550e8400-.../v3/manifest.json',
  files: [
    {
      name: 'openwebui.container',
      url: 'https://static.leger.run/550e8400-.../v3/openwebui.container',
      sha256: '...'
    },
    // ...
  ]
}
CLI workflow:

$ leger deploy install --release my-openwebui

1. CLI: GET /api/config/latest?release=my-openwebui
2. CLI: Download each file from R2 URLs
3. CLI: Verify SHA256 checksums
4. CLI: Install quadlets with podman
5. CLI: Start services
Current status: DOES NOT EXIST

Current CLI only fetches git_url and clones from GitHub directly (api/routes/releases.ts:30-46).

Missing Component #6: Manifest Generation
Required functionality: Generate manifest.json describing deployment

Files needed:

api/lib/manifest-generator.ts
What it should do:

function generateManifest(files: Record<string, string>): Manifest {
  return {
    version: '1.0.0',
    generated_at: new Date().toISOString(),
    files: Object.entries(files).map(([name, content]) => ({
      name,
      size: content.length,
      sha256: sha256(content),
      type: name.endsWith('.container') ? 'container' : 
            name.endsWith('.network') ? 'network' : 
            name.endsWith('.volume') ? 'volume' : 'other'
    })),
    metadata: {
      services: extractServices(files),
      dependencies: extractDependencies(files),
      ports: extractPorts(files)
    }
  }
}
Current status: DOES NOT EXIST

Template Files Mystery
You mentioned: "all the njk templates are already created"

Reality: I cannot find ANY .njk files in this repository:

$ find /home/user -name "*.njk"
(no results)

$ grep -r "nunjucks" api/
(no results in api/ directory)
Possible explanations:

Templates are in a separate repository (not cloned yet?)
Templates will be fetched from a GitHub release (dynamic loading?)
Templates are in a different location on your local machine
Templates are planned but not created yet
Need clarification: Where are the templates located?

Files That Need to Be Created
Backend API Files
1. Template Rendering (api/services/template-renderer.ts)
export class TemplateRenderer {
  async render(templateSet: string, config: ConfigData): Promise<FileSet>
  async validate(files: FileSet): Promise<ValidationResult>
  private loadTemplates(templateSet: string): Promise<Template[]>
}
2. R2 Storage (api/services/r2-storage.ts)
export class R2Storage {
  async uploadRelease(data: UploadReleaseInput): Promise<UploadResult>
  async getLatestVersion(user_uuid: string): Promise<number>
  async getManifest(user_uuid: string, version: number): Promise<Manifest>
  async downloadFile(path: string): Promise<string>
}
3. Deployment Orchestrator (api/services/deployment-orchestrator.ts)
export class DeploymentOrchestrator {
  async createDeployment(release_id: string): Promise<Deployment>
  async processDeployment(deployment_id: string): Promise<void>
  async getDeploymentStatus(deployment_id: string): Promise<DeploymentStatus>
  private async renderPhase(deployment: Deployment): Promise<FileSet>
  private async uploadPhase(deployment: Deployment, files: FileSet): Promise<void>
}
4. Configuration Service (api/services/configurations.ts)
export class ConfigurationService {
  async saveConfiguration(release_id: string, config: ConfigData): Promise<Configuration>
  async getLatestConfiguration(release_id: string): Promise<Configuration | null>
  async getConfigurationHistory(release_id: string): Promise<Configuration[]>
}
5. Deployment Routes (api/routes/deployments.ts)
export async function handleCreateDeployment(request: Request, env: Env): Promise<Response>
export async function handleGetDeploymentStatus(request: Request, env: Env, deployment_id: string): Promise<Response>
6. Configuration Routes (api/routes/configurations.ts)
export async function handleSaveConfiguration(request: Request, env: Env): Promise<Response>
export async function handleGetConfiguration(request: Request, env: Env): Promise<Response>
7. CLI Manifest Routes (api/routes/cli.ts)
export async function handleGetLatestManifest(request: Request, env: Env): Promise<Response>
export async function handleDownloadFile(request: Request, env: Env): Promise<Response>
8. Utilities (api/lib/)
api/lib/nunjucks-engine.ts      - Nunjucks wrapper
api/lib/r2-client.ts             - R2 SDK wrapper  
api/lib/manifest-generator.ts    - Manifest JSON generator
api/lib/file-validator.ts        - Quadlet syntax validation
9. Models (api/models/)
api/models/deployment.ts         - Deployment types
api/models/configuration.ts      - Configuration types
api/models/manifest.ts           - Manifest types
Frontend Files
10. Deployment UI (src/pages/)
src/pages/ReleaseDeployPage.tsx  - Multi-step deployment progress
11. Configuration Form (src/pages/)
src/pages/ReleaseConfigPage.tsx  - 29-variable config form (RJSF?)
12. API Client Updates (src/lib/api-client.ts)
// Add methods:
deployRelease(release_id: string): Promise<Deployment>
getDeploymentStatus(deployment_id: string): Promise<DeploymentStatus>
saveConfiguration(release_id: string, config: ConfigData): Promise<Configuration>
13. Hooks (src/hooks/)
src/hooks/use-deployment.ts      - Deployment polling
src/hooks/use-configuration.ts   - Config management
Recommended Implementation Phases
Phase 1: Template Rendering (Isolated Testing)
Files: template-renderer.ts, nunjucks-engine.ts

Test without DB:

// Stand-alone script
const renderer = new TemplateRenderer()
const config = { enable_openwebui: true, ... }
const files = await renderer.render('openwebui', config)
console.log(files)
Deliverable: Proven template rendering works

Phase 2: R2 Storage (Isolated Testing)
Files: r2-storage.ts, r2-client.ts

Test with wrangler:

// Stand-alone script
const storage = new R2Storage(env.LEGER_STATIC)
await storage.uploadRelease({
  user_uuid: 'test-uuid',
  version: 1,
  files: mockFiles
})
const manifest = await storage.getManifest('test-uuid', 1)
console.log(manifest)
Deliverable: Proven R2 upload/download works

Phase 3: Integration (Orchestrator)
Files: deployment-orchestrator.ts, deployments.ts

Test end-to-end:

curl -X POST http://localhost:8787/api/releases/{id}/deploy

# Returns deployment_id

curl http://localhost:8787/api/deployments/{id}/status

# Polls until status='ready'
Deliverable: Full deploy workflow works

Phase 4: Configuration Management
Files: configurations.ts, configuration routes

Test:

curl -X POST http://localhost:8787/api/releases/{id}/configuration \
  -d '{"config_data": {...}}'

curl http://localhost:8787/api/releases/{id}/configuration
Deliverable: Config persistence works

Phase 5: CLI Pull Mechanism
Files: cli.ts, manifest routes

Test with CLI:

leger deploy install --release my-openwebui

# Should:
# 1. Hit /api/config/latest
# 2. Download files from R2 URLs
# 3. Install with podman
Deliverable: CLI can pull from leger.run

Phase 6: Frontend
Files: UI pages, hooks, API client updates

Test in browser:

Configure release
Click "Deploy"
Watch progress
See "Ready" status with CLI command
Deliverable: Full UI workflow works

Key Questions to Resolve
1. Where are the Nunjucks templates?
Separate repository?
GitHub release URL?
Will be created during this phase?
2. Schema for 29 decision variables
Is src/schemas/config-schema.json (currently empty) the target?
Do you have the variable definitions documented?
3. Synchronous vs Async deployment
Should /api/releases/:id/deploy block until complete?
Or return immediately with deployment_id for polling?
Recommendation: Async with polling (better UX for slow renders)
4. R2 public URL strategy
Should files be publicly accessible?
Or require signed URLs with expiry?
Recommendation: Public read for simplicity (files are quadlets, not secrets)
5. Error handling strategy
If template render fails, should it retry?
How to expose template errors to user?
Recommendation: Fail fast, store error_message in deployments table
Summary
What EXISTS:
✅ Release metadata CRUD
✅ Database schema (prepared)
✅ R2 bucket (empty)
✅ Frontend skeleton
What DOES NOT EXIST:
❌ Template rendering engine
❌ R2 upload/download code
❌ Deployment orchestration
❌ Configuration management
❌ CLI pull endpoints
❌ Manifest generation
❌ Template files (cannot find them)
Estimated Effort:
Template rendering service: 4-6 hours
R2 storage service: 3-4 hours
Deployment orchestrator: 6-8 hours
Configuration management: 2-3 hours
CLI endpoints: 2-3 hours
Frontend UI: 8-10 hours
Testing & integration: 6-8 hours
Total: ~30-40 hours (1 week of focused work)

Next Steps
Before implementation:

✅ Locate/clarify template files location
✅ Define 29-variable schema
✅ Decide sync vs async deployment strategy
✅ Define R2 URL security model
Recommended order:

Build template renderer in isolation
Build R2 storage in isolation
Integrate with orchestrator
Add configuration persistence
Add CLI endpoints
Build frontend UI
This report isolates: All relevant files and functionality needed for v2 save/deploy feature.
